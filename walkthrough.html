
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Data Reduction Walkthrough &#8212; ViSP_Pipeline v0.10.2</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700" type="text/css" />
    <link rel="stylesheet" href="_static/dkist.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="_static/favico.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="A Word About Data, RAM, and Disk Space" href="data_warning.html" />
    <link rel="prev" title="Configuration File Format" href="config_file.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="col-md-3 navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://nso.edu"><img src="_static/img/NSOlogo.gif">
        </a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav hidden">
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">ViSP Pipeline Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_file.html">Configuration File Format</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Reduction Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_warning.html">A Word About Data, RAM, and Disk Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html">Reference/API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Data Reduction Walkthrough</a><ul>
<li><a class="reference internal" href="#input-data">Input Data</a></li>
<li><a class="reference internal" href="#polcal-data">PolCal Data</a></li>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#run">Run</a></li>
<li><a class="reference internal" href="#output-data">Output Data</a></li>
<li><a class="reference internal" href="#spatial-maps">Spatial Maps</a></li>
<li><a class="reference internal" href="#full-spatial-cubes">Full Spatial Cubes</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="config_file.html" title="Previous Chapter: Configuration File Format"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Configuration...</span>
    </a>
  </li>
  <li>
    <a href="data_warning.html" title="Next Chapter: A Word About Data, RAM, and Disk Space"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">A Word About ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>
          
            <ul class="nav navbar-nav navbar-left">
              <li><a href="http://dkist.nso.edu/">DKIST</a></li>
              <li><a href="http://docs.cadair.com/devdocs">DC Developer Guide</a></li>
              <li><a href="http://docs.cadair.com/datarate">DKIST Data Rate</a></li>
              <li><a href="http://docs.cadair.com/datamodel">DKIST Data Model</a></li>
            </ul>
          
          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          

        </div>
    </div>
  </div>

<div class="container">
  <div class="row">

    <div class="col-md-3"><div id="side-logo" >
            <a href="http://dkist.nso.edu">
                <img src="_static/img/DKISTLogo-Medium.jpg">
            </a>
        </div><div id="sidebar" class="bs-sidenav" role="complementary">
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">ViSP Pipeline Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_file.html">Configuration File Format</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Reduction Walkthrough</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-data">Input Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#polcal-data">PolCal Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#output-data">Output Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spatial-maps">Spatial Maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#full-spatial-cubes">Full Spatial Cubes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data_warning.html">A Word About Data, RAM, and Disk Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="API.html">Reference/API</a></li>
</ul>

            
        </div>
    </div>

    <div class="col-md-9 content">
      
  <div class="section" id="data-reduction-walkthrough">
<h1>Data Reduction Walkthrough<a class="headerlink" href="#data-reduction-walkthrough" title="Permalink to this headline">¶</a></h1>
<div class="section" id="input-data">
<h2>Input Data<a class="headerlink" href="#input-data" title="Permalink to this headline">¶</a></h2>
<p>Since version <em>0.7.0</em> the pipeline assumes the input data are similar to how they will come out of the DHS. There will
be one FITS file for each SysOutput, and each file will have a single HDU with both the data and a
SPEC-0122-compliant header. It is possible to put different types of exposures (darks, gains, etc.) into separate
folders, but this is not necessary; the pipeline will segregate data based on the <code class="xref py py-obj docutils literal notranslate"><span class="pre">DKIST004</span></code> header keyword.</p>
<p>For this walkthrough we will use a set of fake data generated by <code class="docutils literal notranslate"><span class="pre">gen_fake_data.py</span></code> (in the main repo directory),
which generates a full suite of input data:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -1 raw
<span class="go">&#39;VISP_2016-06-21T00:00:00.000(UTC)_0.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.033(UTC)_1.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.067(UTC)_2.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.100(UTC)_3.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.133(UTC)_4.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.167(UTC)_5.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.200(UTC)_6.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.233(UTC)_7.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.267(UTC)_8.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:00.300(UTC)_9.fits&#39;</span>
<span class="go">&#39;VISP_2016-06-21T00:00:05.000(UTC)_0.fits&#39;</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<div class="section" id="polcal-data">
<h2>PolCal Data<a class="headerlink" href="#polcal-data" title="Permalink to this headline">¶</a></h2>
<p>We’ll also need a set of ViSP data from a PolCal run.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -1 polcal
<span class="go">&#39;VISP_2016-05-22T00:00:00.000(UTC)_0.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:01.000(UTC)_1.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:02.000(UTC)_2.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:03.000(UTC)_3.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:04.000(UTC)_4.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:05.000(UTC)_5.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:06.000(UTC)_6.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:07.000(UTC)_7.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:08.000(UTC)_8.fits&#39;</span>
<span class="go">&#39;VISP_2016-05-22T00:00:09.000(UTC)_9.fits&#39;</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>To keep things organized lets use a different directory to hold our pipeline outputs and create a default config file
there</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir rdx
<span class="gp">$</span> <span class="nb">cd</span> rdx
<span class="gp">$</span> visp_pipeline -b config.ini
</pre></div>
</div>
<p>Now we’ll need to populate the config file, which should be pretty straight forward.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Main]</span>
<span class="na">raw_sci_dir</span> <span class="o">=</span> <span class="s">../raw</span>
<span class="na">data_set_id</span> <span class="o">=</span>
<span class="na">output_prefix</span> <span class="o">=</span> <span class="s">Sci</span>
<span class="na">dark_cal</span> <span class="o">=</span> <span class="s">DarkCal.fits</span>
<span class="na">lamp_gain_cal</span> <span class="o">=</span> <span class="s">LampGainCal.fits</span>
<span class="na">solar_gain_cal</span> <span class="o">=</span> <span class="s">SolarGainCal.fits</span>
<span class="na">geometric_cal</span> <span class="o">=</span> <span class="s">GeoCal.fits</span>
<span class="na">gen_noise_frames</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">threads</span> <span class="o">=</span> <span class="s">4</span>

<span class="k">[DarkCalibration]</span>
<span class="na">raw_dark_dir</span> <span class="o">=</span> <span class="s">../raw</span>

<span class="k">[LampGainCalibration]</span>
<span class="na">raw_lamp_gain_dir</span> <span class="o">=</span> <span class="s">../raw</span>

<span class="k">[SolarGainCalibration]</span>
<span class="na">raw_solar_gain_dir</span> <span class="o">=</span> <span class="s">../raw</span>

<span class="k">[PolarimetricCalibration]</span>
<span class="na">raw_pol_dir</span> <span class="o">=</span> <span class="s">../polcal</span>
<span class="na">raw_dark_dir</span> <span class="o">=</span> <span class="s">../polcal</span>
<span class="na">raw_lamp_gain_dir</span> <span class="o">=</span> <span class="s">../polcal</span>
<span class="na">raw_solar_gain_dir</span> <span class="o">=</span> <span class="s">../polcal</span>
<span class="na">telescope_db</span> <span class="o">=</span> <span class="s">telescope_db.txt</span>
<span class="na">num_bins_x</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">num_bins_y</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">threads</span> <span class="o">=</span> <span class="s">4</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Generating uncertainty estimates and propagating them through the pipeline takes a lot of work. In some tests it
more than <em>doubles</em> the run time. Only set <code class="xref py py-obj docutils literal notranslate"><span class="pre">gen_noise_frames</span> <span class="pre">=</span> <span class="pre">True</span></code> if you really need those uncertainties.</p>
</div>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>This is the easy part, just call the pipeline</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> visp_pipeline config.ini
</pre></div>
</div>
<p>Reducing the PolCal data takes about 15 minutes and after that each Data frame takes about 1 thread-minute to process.</p>
<p>The ViSP Pipeline produces a lot of status messages and it is usually a good idea to save these somewhere so you can see exactly
what was done to the data at a later time (and find any error messages). To do this I usually run the pipeline as</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> visp_pipeline config.ini <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee spool.txt
</pre></div>
</div>
<p>On most systems this will cause your terminal (stdout) to update much less frequently than usual. This is due to how
python decides to flush its buffer to stdout. If you want to save a spool file <em>and</em> get real-time status messages then
you need to set the environmental variable <code class="xref py py-obj docutils literal notranslate"><span class="pre">PYTHONUNBUFFERED=yes</span></code>.</p>
</div>
<div class="section" id="output-data">
<h2>Output Data<a class="headerlink" href="#output-data" title="Permalink to this headline">¶</a></h2>
<p>If your config file looks like the one above then your reduction directory will now look like this</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -1
<span class="go">config.ini</span>
<span class="go">DarkCal.fits</span>
<span class="go">GeoCal.fits</span>
<span class="go">LampGainCal.fits</span>
<span class="go">Sci.0555.fits</span>
<span class="go">SolarGainCal.fits</span>
</pre></div>
</div>
<p>All of the <code class="docutils literal notranslate"><span class="pre">*Cal.fits</span></code> files are the intermediate data products used by the pipeline whose names are specified in the
config file.</p>
<p>The processed data live in <code class="docutils literal notranslate"><span class="pre">Sci.XXXX.fits</span></code>. These files each contain a single Primary HDU with no data and 4
ImageHDUs, one for each of the four Stokes vectors. The <code class="docutils literal notranslate"><span class="pre">XXXX</span></code> corresponds to the slit position (read from
the <code class="docutils literal notranslate"><span class="pre">VISP_CSS</span></code> header value).</p>
</div>
<div class="section" id="spatial-maps">
<h2>Spatial Maps<a class="headerlink" href="#spatial-maps" title="Permalink to this headline">¶</a></h2>
<p>If (unlike the example above) a range of slit positions have been reduced it is possible to extract a spatial map at a
particular Stokes parameter and wavelength. The first step is to open a single reduced slit position and determine which
column corresponds to the wavelength you want (let’s say the column is 123). Once that is know run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span> <span class="o">=</span> <span class="mi">123</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stokes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">num_col_avg</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ViSP_Pipeline</span> <span class="kn">import</span> <span class="n">Data</span><span class="p">,</span> <span class="n">generic</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">I</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">FitsData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">I</span><span class="o">.</span><span class="n">load_polarimetric_fitsData</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="s1">&#39;Sci*.fits&#39;</span><span class="p">,</span><span class="n">stokes</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">map</span> <span class="o">=</span> <span class="n">generic</span><span class="o">.</span><span class="n">extract_map</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">num_col_avg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">map</span><span class="o">.</span><span class="n">write_out</span><span class="p">(</span><span class="s1">&#39;I.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The file ‘I.fits’ will now have the spatial map of Stokes I at whatever wavelength is at column 123. The <code class="docutils literal notranslate"><span class="pre">num_col_avg</span></code>
variable controls how many columns to average together when constructing the map.</p>
</div>
<div class="section" id="full-spatial-cubes">
<h2>Full Spatial Cubes<a class="headerlink" href="#full-spatial-cubes" title="Permalink to this headline">¶</a></h2>
<p>If a single wavelength isn’t good enough for you and you have a lot of memory/disk space then it is also possible to
produce 3D data cubes for a given Stokes vector:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ViSP_Pipeline</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Q</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">FitsData</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Q</span><span class="o">.</span><span class="n">load_polarimetric_fitsData</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="s1">&#39;Sci*.fits&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">get_stacked_data</span><span class="p">(),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;I_cube.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">np.swapaxes</span></code> call is necessary to format the data correctly for viewing with ds9.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Generating spatial maps and full cubes can be very resource intensive. If you are getting errors then check out
<a class="reference internal" href="data_warning.html#data-warning"><span class="std std-ref">A Word About Data, RAM, and Disk Space</span></a>.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <div class="left-footer">
         &copy; 2018, Arthur Eigenbrot
       <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    </div>
   
    <div class="right-footer">
      Last updated on 09 Aug 2018.
    </div>
    <div class="centre-footer">
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6
    </div>
  </div>
</footer>
  </body>
</html>